#!/usr/bin/env php
<?php

use Garden\Cli\Cli;
use Aivec\WordPress\CodeceptDocker\Config;
use Aivec\WordPress\CodeceptDocker\Logger;
use Aivec\WordPress\CodeceptDocker\CLI\Client;
use Aivec\WordPress\CodeceptDocker\CLI\Commands;

require_once 'vendor/autoload.php';

// Define a cli with commands.
$cli = Cli::create()
    ->command('create-config')
    ->description('Create codecept-docker.json config file in project directory.')
    ->opt('namespace:n', 'Prefix for Docker containers', false, 'string')
    ->opt('type:t', 'Project type. Must be one of "plugin", "theme", or "library"', true, 'string')
    ->command('create-scaffolding')
    ->description('Create Codeception scaffolding if it does not exist already (includes yml config files, test folders, etc.). ')
    ->command('init')
    ->description('Create Docker containers and Codeception scaffolding')
    ->command('up')
    ->description('Create Docker containers. If you also want Codeception scaffolding, use "init" instead.')
    ->command('start')
    ->description('Start stopped containers')
    ->command('stop')
    ->description('Stop running containers')
    ->command('down')
    ->description('Stops and removes containers. NOTE: you will have to call "up" again if you do this')
    ->command('update')
    ->description('Updates wordpress and wp-cli Docker images to latest')
    ->command('codecept')
    ->description('Calls and passes args to codecept script from within Docker container')
    ->command('wp-cli')
    ->description('Runs and passes command/arguments to wp-cli container for Docker installs');

// Parse and return cli args.
$args = $cli->parse($argv, true);

$conf = null;
if (!in_array($argv[1], ['create-config', 'update'], true)) {
    if (!file_exists(Client::getAbsPath() . '/codecept-docker.json')) {
        (new Logger())->error('codecept-docker.json does not exist in project directory. Create one with "aivec-codecept create-config --type=<type>"');
        exit(1);
    }
    $conf = json_decode(file_get_contents(Client::getAbsPath() . '/codecept-docker.json'), true);
}

switch ($argv[1]) {
    case 'create-config':
        (new Commands\CreateConfig($args))->run();
        break;
    case 'create-scaffolding':
        (new Commands\CreateScaffolding($conf))->run();
        break;
    case 'init':
        (new Commands\Init($conf))->run();
        break;
    case 'up':
        (new Commands\Up($conf))->run();
        break;
    case 'start':
        (new Commands\Start($conf))->run();
        break;
    case 'stop':
        (new Commands\Stop($conf))->run();
        break;
    case 'down':
        (new Commands\Down($conf))->run();
        break;
    case 'update':
        Commands\Update::update();
        break;
    case 'codecept':
        (new Client(new Config($conf)))->codecept(isset($argv[2]) ? join(' ', array_slice($argv, 2)) : '');
        break;
    case 'wp-cli':
        (new Client(new Config($conf)))->wpcli($argv);
        break;
}
